<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Console Capture</title>
  </head>
  <body>
    <h3>Console Capture Script</h3>
    <p>This page forwards window.console logs to the console server.</p>
    <script>
      (function(){
        const server = (new URLSearchParams(location.search)).get('server') || 'http://localhost:9229';

        function send(payload) {
          try {
            fetch(server + '/log', { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } });
          } catch (e) { /* ignore */ }
        }

        const levels = ['log','info','warn','error','debug'];
        levels.forEach(level => {
          const orig = console[level] || console.log;
          console[level] = function(...args){
            send({ level, args });
            orig.apply(console, args);
          };
        });

        window.addEventListener('error', e => send({ level: 'error', args: [e.message, e.filename, e.lineno, e.colno, e.error && e.error.stack] }));
        window.addEventListener('unhandledrejection', e => send({ level: 'error', args: ['UnhandledRejection', e.reason] }));

        // If ws available on client, try to use it
        try {
          const wsProto = server.startsWith('https') ? 'wss' : 'ws';
          const url = server.replace(/^http/, wsProto).replace(/\/log$/, '') + '/';
          const ws = new WebSocket(url);
          ws.addEventListener('open', () => console.info('Console capture websocket connected'));
          levels.forEach(level => {
            const orig = console[level] || console.log;
            console[level] = function(...args){
              try { ws.send(JSON.stringify({ level, args })); } catch(e) {}
              orig.apply(console, args);
            };
          });
        } catch (e) {}
      })();
    </script>
  </body>
</html>
