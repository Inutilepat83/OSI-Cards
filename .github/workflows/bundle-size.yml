name: Bundle Size Monitor

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Library
        run: npm run build:lib

      - name: Build Application
        run: npm run build -- --configuration=production

      - name: Analyze Bundle Size
        id: bundle-size
        run: |
          # Get bundle sizes
          MAIN_SIZE=$(du -sh dist/osi-cards/*.js | grep main | awk '{print $1}')
          POLYFILLS_SIZE=$(du -sh dist/osi-cards/polyfills*.js | awk '{print $1}')
          TOTAL_SIZE=$(du -sh dist/osi-cards | awk '{print $1}')

          echo "main_size=$MAIN_SIZE" >> $GITHUB_OUTPUT
          echo "polyfills_size=$POLYFILLS_SIZE" >> $GITHUB_OUTPUT
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT

          # Check against limits
          MAIN_KB=$(du -k dist/osi-cards/*.js | grep main | awk '{print $1}')
          if [ "$MAIN_KB" -gt 500 ]; then
            echo "‚ö†Ô∏è Main bundle exceeds 500KB!"
            exit 1
          fi

      - name: Comment PR
        uses: actions/github-script@v8
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const mainSize = '${{ steps.bundle-size.outputs.main_size }}';
            const polyfillsSize = '${{ steps.bundle-size.outputs.polyfills_size }}';
            const totalSize = '${{ steps.bundle-size.outputs.total_size }}';

            const comment = `## üì¶ Bundle Size Report

            | Bundle | Size |
            |--------|------|
            | Main | ${mainSize} |
            | Polyfills | ${polyfillsSize} |
            | **Total** | **${totalSize}** |

            ${mainSize > '500K' ? '‚ö†Ô∏è Main bundle exceeds 500KB limit!' : '‚úÖ Bundle size within limits'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload Bundle Stats
        uses: actions/upload-artifact@v3
        with:
          name: bundle-stats
          path: dist/osi-cards/stats.json

