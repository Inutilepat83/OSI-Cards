<div
  *ngIf="cardConfig"
  #cardContainer
  class="w-full"
  [class.max-w-none]="isFullscreen"
  (mouseenter)="onMouseEnter($event)"
  (mouseleave)="onMouseLeave()"
  (mousemove)="onMouseMove($event)"
>
  <div class="tilt-container glow-container w-full" 
       [ngClass]="{ 'max-w-none': isFullscreen }"
       #tiltContainer
       [ngStyle]="tiltStyle">
      <article
        class="ai-card-surface"
        [ngClass]="{ 'ai-card-surface--fullscreen': isFullscreen, 'ai-card-surface--empty-state': !processedSections.length }"
        [attr.aria-label]="(cardConfig && cardConfig.cardTitle) || 'Card'"
        [attr.aria-describedby]="(cardConfig && cardConfig.cardSubtitle) ? 'card-subtitle' : null"
        role="article"
      >
          <!-- Title and button at the top of the card -->
          <div *ngIf="processedSections.length" class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-foreground" id="card-title">
              {{ cardConfig.cardTitle }}
            </h1>
            <button
              type="button"
              class="ai-card-fullscreen-btn"
              [attr.aria-label]="isFullscreen ? 'Exit fullscreen' : 'Enter fullscreen'"
              (click)="toggleFullscreen()"
            >
              <lucide-icon [name]="isFullscreen ? 'minimize-2' : 'maximize-2'" [size]="16" aria-hidden="true"></lucide-icon>
            </button>
          </div>

          <p *ngIf="processedSections.length && cardConfig.cardSubtitle" class="ai-card-subtitle" id="card-subtitle">
            {{ cardConfig.cardSubtitle }}
          </p>

          <ng-container *ngIf="processedSections.length; else emptyState">
            <app-masonry-grid
              [sections]="processedSections"
              [gap]="12"
              [minColumnWidth]="280"
              class="w-full"
              [attr.aria-label]="'Card sections: ' + processedSections.length + ' section' + (processedSections.length !== 1 ? 's' : '')"
              (sectionEvent)="onSectionEvent($event)"
              (layoutChange)="onLayoutChange($event)"
            ></app-masonry-grid>
          </ng-container>

          <ng-template #emptyState>
            <div 
              class="card-empty-state"
              #emptyStateContainer
              (mousemove)="onEmptyStateMouseMove($event)"
              (mouseleave)="onEmptyStateMouseLeave()">
              <div class="empty-state-background">
                <div class="empty-state-gradient" [style.transform]="gradientTransform"></div>
                <div class="empty-state-particles">
                  <div 
                    *ngFor="let particle of particles; let i = index"
                    class="particle"
                    [class]="'particle-' + (i + 1)"
                    [style.transform]="particle.transform"
                    [style.opacity]="particle.opacity">
                  </div>
                </div>
              </div>
              <div class="empty-state-content" [style.transform]="contentTransform">
                <div class="empty-state-text">
                  <h3 class="empty-state-title">Creating OSI Card</h3>
                  <div class="empty-state-message-container">
                    <p class="empty-state-message" [@messageAnimation]="currentMessageIndex">
                      {{ currentMessage }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>

        <!-- Action Buttons -->
        <div *ngIf="processedSections.length" class="mt-auto" style="margin-top: var(--section-card-gap, 12px); padding-bottom: 16px;">
          <div class="flex flex-wrap items-center gap-3" style="margin-left: 4px; margin-right: 4px;">
            <button
              *ngFor="let action of cardConfig.actions; trackBy: trackAction"
              type="button"
              class="px-5 py-2.5 text-sm transition-all duration-200 flex items-center gap-2 cursor-pointer"
              [ngClass]="getActionButtonClasses(action)"
              [style.border-radius]="'var(--section-card-border-radius, 10px)'"
              [attr.aria-label]="action.label + (action.type === 'website' && action.url ? ': ' + action.url : '')"
              [attr.aria-describedby]="action.type === 'mail' ? 'action-mail-hint' : null"
              (click)="onActionClick(action)"
              (keydown.enter)="onActionClick(action)"
              (keydown.space)="$event.preventDefault(); onActionClick(action)"
            >
              <!-- Lucide icon (for type defaults or explicit lucide icon names) -->
              <lucide-icon 
                *ngIf="getActionIconNameForDisplay(action) as iconName"
                [name]="iconName"
                [size]="16"
                aria-hidden="true">
              </lucide-icon>
              <!-- Image icon (for URL-based icons) -->
              <img 
                *ngIf="hasImageIcon(action)"
                [src]="action.icon"
                [alt]="action.label + ' icon'"
                style="width: 16px; height: 16px;"
                aria-hidden="true"
              />
              <!-- Text icon (for emoji or text-based icons) -->
              <span *ngIf="hasTextIcon(action)" aria-hidden="true">{{ action.icon }}</span>
              <span>{{ action.label }}</span>
            </button>
          </div>
        </div>

        <!-- Signature at bottom of card -->
        <div *ngIf="processedSections.length" class="text-xs text-muted-foreground/60 text-center">
          Powered by Orange Sales Intelligence
        </div>
      </article>
  </div>
</div>
