/* ============================================================
   MASONRY LAYOUT STYLES
   Standardized: 200px min column width, 12px gap

   Supports:
   - CSS native masonry (when browser supports it)
   - JavaScript-based fallback with absolute positioning
   - CSS Grid with dense packing as intermediate fallback
   ============================================================ */

/* ============================================================
   CSS NATIVE MASONRY (Progressive Enhancement)
   Use when browser supports grid-template-rows: masonry
   ============================================================ */
@supports (grid-template-rows: masonry) {
  .masonry-container--native {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(var(--section-grid-min-width, 260px), 1fr));
    grid-template-rows: masonry;
    gap: var(--section-card-gap, 12px);
    align-tracks: stretch;

    /* Native masonry doesn't need absolute positioning */
    .masonry-item {
      position: relative !important;
      left: auto !important;
      top: auto !important;
      width: auto !important;
    }
  }
}

/* ============================================================
   CSS GRID DENSE PACKING FALLBACK
   Better than simple grid, handles varying heights
   ============================================================ */
.masonry-container--grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--section-grid-min-width, 260px), 1fr));
  grid-auto-rows: minmax(100px, auto);
  grid-auto-flow: dense;
  gap: var(--section-card-gap, 12px);

  /* Items span based on col-span data attribute */
  .masonry-item {
    position: relative;

    &[data-col-span="2"] {
      grid-column: span 2;
    }

    &[data-col-span="3"] {
      grid-column: span 3;
    }

    &[data-col-span="4"] {
      grid-column: span 4;
    }
  }

  /* Ensure wide items don't overflow on small screens */
  @media (max-width: 600px) {
    .masonry-item[data-col-span] {
      grid-column: span 1;
    }
  }
}

/* ============================================================
   CSS SUBGRID SUPPORT (for aligned headers/bodies)
   ============================================================ */
@supports (grid-template-rows: subgrid) {
  .masonry-container--subgrid .masonry-item {
    display: grid;
    grid-template-rows: subgrid;
    grid-row: span 2; /* Header + body */

    .ai-section__header {
      grid-row: 1;
    }

    .ai-section__body {
      grid-row: 2;
    }
  }
}

/* ============================================================
   JAVASCRIPT-BASED MASONRY (Default/Fallback)
   Uses absolute positioning calculated by component
   ============================================================ */
.masonry-grid-container {
  position: relative;
  width: 100%;
  height: auto;
  min-height: 200px;

  /* GPU acceleration for smooth height changes */
  will-change: height;
  transform: translateZ(0);
}

.masonry-grid-container .masonry-item {
  position: absolute;
  width: auto;
  height: auto;
  box-sizing: border-box;
  transform-origin: top left;

  /* FLIP animation support */
  will-change: transform, opacity;
  backface-visibility: hidden;
}

.masonry-item {
  height: fit-content;
  min-height: fit-content;
  width: 100%;
  break-inside: avoid;
  page-break-inside: avoid;
  display: flex;
  flex-direction: column;
  overflow: visible;
  box-sizing: border-box;
  overflow-wrap: break-word;
  word-wrap: break-word;

  /* Smooth transitions for position and size changes */
  transition:
    top 0.4s cubic-bezier(0.4, 0, 0.2, 1),
    left 0.4s cubic-bezier(0.4, 0, 0.2, 1),
    width 0.4s cubic-bezier(0.4, 0, 0.2, 1),
    opacity 0.35s ease-out;

  /* GLOBALLY DEFINED: Use shared mixins for discrete section borders */
  @include surface-section-base;
  padding: var(--section-container-padding) !important;

  /* Gap between header and body - standardized to 12px */
  gap: var(--section-card-gap);

  &:hover {
    @include surface-section-hover;
  }
}

.masonry-item > * {
  height: auto !important;
  min-height: fit-content !important;
  max-height: none !important;
}

/* ============================================================
   LEGACY GRID CLASSES
   Using standardized 200px min width, 12px gap
   ============================================================ */

.masonry-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  grid-gap: 12px;
  grid-auto-rows: minmax(100px, auto);
}

.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  grid-gap: 12px;
}

/* ============================================================
   SECTION ORIENTATION MODIFIERS
   Controls how content is arranged within sections
   ============================================================ */

/* Vertical orientation (default) - stack items in a column */
.masonry-item--vertical .ai-section__body {
  display: flex !important;
  flex-direction: column !important;
  flex-wrap: nowrap !important;
  align-items: stretch !important;
  gap: var(--section-card-gap) !important;
}

/* Horizontal orientation - arrange items in a row */
.masonry-item--horizontal .ai-section__body {
  display: flex !important;
  flex-direction: row !important;
  flex-wrap: wrap !important;
  align-items: flex-start !important;
  gap: var(--section-card-gap) !important;
}

/* Horizontal card sizing within horizontal sections */
.masonry-item--horizontal .ai-section__body > * {
  flex: 1 1 200px !important;
  min-width: 180px !important;
  max-width: 100% !important;
}

/* Contact cards in horizontal mode */
.masonry-item--horizontal .contact-card,
.masonry-item--horizontal .network-card {
  flex: 1 1 220px !important;
  min-width: 200px !important;
  max-width: 320px !important;
}

/* Metrics in horizontal mode - more compact */
.masonry-item--horizontal .analytics-metric,
.masonry-item--horizontal .financial-metric {
  flex: 1 1 160px !important;
  min-width: 140px !important;
  max-width: 260px !important;
}

/* Overview cards in horizontal mode */
.masonry-item--horizontal .overview-card {
  flex: 1 1 180px !important;
  min-width: 160px !important;
  max-width: 280px !important;
}

/* Auto orientation - let container queries decide */
.masonry-item--auto .ai-section__body {
  display: flex !important;
  flex-direction: column !important;
  flex-wrap: wrap !important;
  gap: var(--section-card-gap) !important;
}

/* Auto orientation switches to row on wide sections */
@container (min-width: 500px) {
  .masonry-item--auto .ai-section__body {
    flex-direction: row !important;
  }

  .masonry-item--auto .ai-section__body > * {
    flex: 1 1 200px !important;
    min-width: 180px !important;
  }
}

/* Responsive orientation switching */
/* At narrow widths, horizontal sections become vertical */
@media (max-width: 480px) {
  .masonry-item--horizontal .ai-section__body {
    flex-direction: column !important;
    flex-wrap: nowrap !important;
  }

  .masonry-item--horizontal .ai-section__body > * {
    flex: 1 1 auto !important;
    min-width: 100% !important;
    max-width: 100% !important;
  }
}

/* Container query support for per-section responsiveness */
.masonry-item {
  container-type: inline-size;
  container-name: section;
}

/* Priority-based visual indicators */
.masonry-item--priority-critical {
  /* Critical sections get subtle emphasis */
  &::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--color-brand, #FF7900);
    border-radius: 0 2px 2px 0;
  }
}

.masonry-item--priority-important {
  /* Important sections - no special border, use unified styling */
  /* Left accent border removed for consistency */
}

/* Sticky sections */
.masonry-item--sticky {
  position: sticky !important;
  top: 0 !important;
  z-index: 10 !important;
  background: var(--card-background) !important;
}

/* Flex grow sections - expand to fill space */
.masonry-item--flex-grow {
  flex-grow: 1 !important;
}

/* ============================================================
   REDUCED MOTION SUPPORT
   ============================================================ */

@media (prefers-reduced-motion: reduce) {
  .masonry-item,
  .masonry-grid-container .masonry-item {
    transition: none;
  }
}

/* ============================================================
   LAYOUT MODE MODIFIERS
   ============================================================ */

/* Compact mode - tighter spacing */
.masonry-container--compact {
  --section-card-gap: 8px;

  .masonry-item {
    padding: calc(var(--section-container-padding) * 0.75) !important;
  }
}

/* Comfortable mode - more spacing */
.masonry-container--comfortable {
  --section-card-gap: 16px;

  .masonry-item {
    padding: calc(var(--section-container-padding) * 1.25) !important;
  }
}

/* Track-aligned mode - sections snap to row tracks */
.masonry-container--track-aligned {
  /* Use CSS Grid for track alignment */
  display: grid;
  grid-template-columns: repeat(var(--masonry-columns, 4), 1fr);
  grid-auto-rows: minmax(50px, auto);
  gap: var(--section-card-gap, 12px);

  .masonry-item {
    position: relative !important;
    left: auto !important;
    top: auto !important;
    width: auto !important;

    /* Align to nearest row track */
    align-self: start;
  }
}

/* ============================================================
   VISUAL DEBUGGING MODE
   ============================================================ */

.masonry-container--debug {
  /* Show grid lines */
  background-image:
    linear-gradient(to right, rgba(255, 121, 0, 0.1) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(255, 121, 0, 0.1) 1px, transparent 1px);
  background-size: calc(100% / var(--masonry-columns, 4)) 50px;

  .masonry-item {
    outline: 2px dashed rgba(255, 121, 0, 0.5) !important;
    outline-offset: -2px;

    /* Show col-span as badge */
    &::after {
      content: attr(data-col-span) ' col';
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255, 121, 0, 0.9);
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 100;
      pointer-events: none;
    }

    /* Show priority badge */
    &[data-priority="critical"]::before {
      content: '★ Critical';
      position: absolute;
      top: 4px;
      left: 4px;
      background: #ef4444;
      color: white;
      font-size: 9px;
      font-weight: 600;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 100;
    }

    &[data-priority="important"]::before {
      content: '◆ Important';
      position: absolute;
      top: 4px;
      left: 4px;
      background: #f59e0b;
      color: white;
      font-size: 9px;
      font-weight: 600;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 100;
    }

    &[data-priority="optional"]::before {
      content: '○ Optional';
      position: absolute;
      top: 4px;
      left: 4px;
      background: #6b7280;
      color: white;
      font-size: 9px;
      font-weight: 600;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 100;
    }
  }
}

/* ============================================================
   STAGGERED ANIMATION SUPPORT
   ============================================================ */

.masonry-container--stagger-animations {
  .masonry-item {
    animation: masonry-item-appear 0.4s cubic-bezier(0.4, 0, 0.2, 1) backwards;

    @for $i from 1 through 20 {
      &:nth-child(#{$i}) {
        animation-delay: #{($i - 1) * 50}ms;
      }
    }
  }
}

@keyframes masonry-item-appear {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}
