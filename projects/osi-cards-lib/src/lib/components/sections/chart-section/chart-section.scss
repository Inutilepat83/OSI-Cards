// =====================================================================
// CHART SECTION - Compact, Responsive, Consistent
// =====================================================================

// Use design system (must come before @import)
@use "../../../styles/components/sections/design-system" as *;
@use "../../../styles/components/sections/typography-system" as typo;
@use "../../../styles/responsive" as *;
@use "../../../styles/components/sections/section-animations" as *;

// Import base section styles
@import "../../../styles/components/sections/sections-base";
@import "../../../styles/components/sections/section-shell";

:host {
  display: block;
  width: 100%;
}

.chart-wrapper {
  // Chart container - use section item background
  background: var(--section-item-background) !important;
  border: 1px solid var(--border);
  box-shadow: none;
  overflow: hidden; // Keep overflow hidden for layout, Chart.js handles internal layout
  height: auto; // Auto height to fit content
  min-height: 200px; // Minimum height for chart visibility
  max-height: none; // Remove max-height restriction
  padding: 0; // Remove padding to eliminate blank space
  position: relative; // Required for loading overlay positioning
  border-radius: var(
    --osi-section-item-border-radius,
    var(--section-item-border-radius, var(--radius-md, 8px))
  ); // Theme-aware border radius
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;

  // Smooth transitions matching design system
  transition:
    border-color 0.22s cubic-bezier(0.4, 0, 0.2, 1),
    box-shadow 0.22s cubic-bezier(0.4, 0, 0.2, 1);

  // Hover effect matching design system
  &:hover {
    background: var(--section-item-background-hover, var(--section-item-background)) !important;
    border-color: var(--osi-section-item-border-hover-enhanced-color, var(--border));
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  @media (prefers-reduced-motion: reduce) {
    transition: none;
  }

  // Responsive min-height adjustments - let Chart.js determine actual height
  @include responsive-down("lg") {
    min-height: 200px;
  }

  @include responsive-down("md") {
    min-height: 240px; // Enough for chart with bottom legend
  }

  @include responsive-down("sm") {
    min-height: 280px; // Enough for chart with bottom legend and rotated labels
  }

  @include responsive-down("xs") {
    min-height: 320px; // Enough for chart with legend and rotated labels on smallest screens
  }
}

.chart-container {
  width: 100%;
  height: 100%; // Fill parent container
  min-height: 200px; // Minimum height for chart area
  position: relative;
  display: flex;
  align-items: stretch; // Stretch to fill container
  justify-content: center;
  border-radius: 0 !important; // Ensure no rounded corners
  background: transparent; // Transparent so chart wrapper background shows through

  // Responsive chart container min-heights
  @include responsive-down("md") {
    min-height: 240px; // Chart area on small screens
  }

  @include responsive-down("sm") {
    min-height: 280px; // Chart area on very small screens
  }

  @include responsive-down("xs") {
    min-height: 320px; // Chart area on smallest screens
  }

  canvas {
    width: 100% !important;
    max-width: 100%;
    // Don't set fixed height - let Chart.js calculate based on maintainAspectRatio: false
    // Chart.js will size the canvas to fit its content (chart + legend + padding)
    border-radius: 0 !important; // Ensure canvas has no rounded corners
    display: block !important; // Ensure canvas is visible
    background: transparent; // Transparent canvas background
    // Chart.js with maintainAspectRatio: false will size canvas to fit all content

    // Improve touch interaction on mobile devices
    touch-action: pan-y pinch-zoom;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
}

.chart-loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: color-mix(in srgb, var(--section-item-background) 85%, transparent);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--osi-section-item-gap, var(--spacing-sm)); // Use design system gap
  z-index: 1000;
  pointer-events: none;
  transition: opacity var(--duration-slow, 300ms)
    var(--ease-out-smooth, cubic-bezier(0.4, 0, 0.2, 1));

  .chart-loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid color-mix(in srgb, var(--foreground) 20%, transparent);
    border-top-color: var(
      --accent,
      var(--status-info, #3b82f6)
    ); // Use accent color from design system
    border-radius: 50%;
    animation: chart-spin 1s linear infinite;
  }

  .chart-loading-text {
    @include typo.label-base;
    color: var(--muted-foreground);
    font-size: var(--text-sm, 0.875rem);
  }
}

@keyframes chart-spin {
  to {
    transform: rotate(360deg);
  }
}

// Chart.js theme-aware styling
:host ::ng-deep {
  // Ensure chart canvas is visible
  canvas {
    display: block !important;
    max-width: 100%;
    background: transparent !important; // Ensure canvas background is transparent
    opacity: 1 !important; // Ensure canvas is fully visible
  }

  // Chart.js container styling
  .chartjs-render-monitor {
    width: 100% !important;
    background: transparent !important; // Ensure container background is transparent
  }

  // Chart.js legend is rendered within the chart canvas
  // Chart.js automatically adjusts layout padding to accommodate legend
  // No additional styling needed - legend visibility is handled by Chart.js options

  // Chart.js tooltip styling - using design system variables
  .chartjs-tooltip {
    background-color: var(--section-item-background) !important;
    color: var(--foreground) !important;
    border: 1px solid var(--border) !important;
    border-radius: var(--radius-md, 8px) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    padding: var(--spacing-sm, 8px) var(--spacing-md, 12px) !important;
    max-width: 200px;
    z-index: 1000;
    pointer-events: none; // Improve touch interaction on mobile

    @include responsive-down("sm") {
      padding: 6px 10px !important;
      max-width: min(180px, 85vw); // Ensure tooltip doesn't overflow viewport
      font-size: 0.875rem; // Slightly smaller text on small screens
    }

    @include responsive-down("xs") {
      padding: 5px 8px !important;
      max-width: min(160px, 80vw);
      font-size: 0.8125rem; // Even smaller on very small screens
    }
  }

  // Chart.js tooltip text
  .chartjs-tooltip-body {
    color: var(--foreground) !important;

    li {
      margin: var(--osi-section-item-gap-xs, 0.25rem) 0 !important;
    }
  }

  // Chart.js tooltip title
  .chartjs-tooltip-header {
    color: var(--foreground) !important;
    border-bottom: var(--osi-section-item-border, 1px solid var(--border));
    margin-bottom: var(--osi-section-item-gap-sm, 0.5rem);
    padding-bottom: var(--osi-section-item-gap-xs, 0.25rem);
  }

  // Ensure chart container accommodates legend
  chartjs-chart {
    width: 100%;
    display: block;
  }
}
