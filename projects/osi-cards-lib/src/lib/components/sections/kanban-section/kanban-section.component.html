<div class="kanban-section">
  @if (columns.length > 0) {
    <div class="kanban-board">
      @for (column of columns; track column.id) {
        <div
          class="kanban-column"
          [class.kanban-column--collapsed]="isCollapsed(column.id)"
          [class.kanban-column--at-limit]="isColumnAtLimit(column)">

          <!-- Column header -->
          <div
            class="kanban-column-header"
            [style.--column-color]="column.color || '#94a3b8'">
            <div class="kanban-column-title">
              <span class="kanban-column-indicator"></span>
              <h4>{{ column.title }}</h4>
              <span class="kanban-column-count">{{ getColumnCount(column) }}</span>
              @if (column.limit) {
                <span class="kanban-column-limit">/ {{ column.limit }}</span>
              }
            </div>
            <button
              type="button"
              class="kanban-column-toggle"
              (click)="toggleColumn(column.id)"
              [attr.aria-label]="isCollapsed(column.id) ? 'Expand column' : 'Collapse column'">
              <lucide-icon
                [name]="isCollapsed(column.id) ? 'chevron-right' : 'chevron-down'"
                [size]="16">
              </lucide-icon>
            </button>
          </div>

          <!-- Column cards -->
          @if (!isCollapsed(column.id)) {
            <div class="kanban-column-cards">
              @for (card of getColumnCards(column); track trackItem($index, card); let i = $index) {
                <div
                  class="kanban-card"
                  [class]="getPriorityClass(card.priority)"
                  [style.--stagger-index]="i"
                  [ngClass]="getItemAnimationClass(getItemId(card, i), i)"
                  (click)="onCardClick(card)"
                  (keydown.enter)="onCardClick(card)"
                  tabindex="0"
                  role="article">

                  <!-- Priority indicator -->
                  @if (card.priority) {
                    <div class="kanban-card-priority kanban-card-priority--{{ card.priority }}">
                      <lucide-icon [name]="getPriorityIcon(card.priority)" [size]="12"></lucide-icon>
                    </div>
                  }

                  <!-- Card title -->
                  @if (card.title) {
                    <h5 class="kanban-card-title">{{ card.title }}</h5>
                  }

                  <!-- Card description -->
                  @if (card.description) {
                    <p class="kanban-card-description">{{ card.description }}</p>
                  }

                  <!-- Tags -->
                  @if (card.tags && card.tags.length > 0) {
                    <div class="kanban-card-tags">
                      @for (tag of card.tags; track tag) {
                        <span class="kanban-card-tag">{{ tag }}</span>
                      }
                    </div>
                  }

                  <!-- Progress bar -->
                  @if (card.progress !== undefined) {
                    <div class="kanban-card-progress">
                      <div
                        class="kanban-card-progress-bar"
                        [style.width.%]="card.progress">
                      </div>
                      <span class="kanban-card-progress-text">{{ card.progress }}%</span>
                    </div>
                  }

                  <!-- Card footer -->
                  <div class="kanban-card-footer">
                    <!-- Due date -->
                    @if (card.dueDate) {
                      <div
                        class="kanban-card-due"
                        [class.kanban-card-due--overdue]="isOverdue(card.dueDate)">
                        <lucide-icon name="calendar" [size]="12"></lucide-icon>
                        <span>{{ formatDueDate(card.dueDate) }}</span>
                      </div>
                    }

                    <!-- Subtasks -->
                    @if (card.subtasks) {
                      <div class="kanban-card-subtasks">
                        <lucide-icon name="check-square" [size]="12"></lucide-icon>
                        <span>{{ card.subtasks.completed }}/{{ card.subtasks.total }}</span>
                      </div>
                    }

                    <!-- Comments -->
                    @if (card.comments) {
                      <div class="kanban-card-comments">
                        <lucide-icon name="message-circle" [size]="12"></lucide-icon>
                        <span>{{ card.comments }}</span>
                      </div>
                    }

                    <!-- Attachments -->
                    @if (card.attachments) {
                      <div class="kanban-card-attachments">
                        <lucide-icon name="paperclip" [size]="12"></lucide-icon>
                        <span>{{ card.attachments }}</span>
                      </div>
                    }

                    <!-- Assignee -->
                    @if (card.assignee) {
                      <div class="kanban-card-assignee" [title]="card.assignee">
                        @if (card.assigneeAvatar) {
                          <img
                            [src]="card.assigneeAvatar"
                            [alt]="card.assignee"
                            class="kanban-card-avatar">
                        } @else {
                          <div class="kanban-card-avatar kanban-card-avatar--initials">
                            {{ getInitials(card.assignee) }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              } @empty {
                <div class="kanban-column-empty">
                  <lucide-icon name="inbox" [size]="20"></lucide-icon>
                  <span>No items</span>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  } @else {
    <div class="kanban-empty">
      <lucide-icon name="columns" [size]="24"></lucide-icon>
      <span>No kanban data available</span>
    </div>
  }
</div>

