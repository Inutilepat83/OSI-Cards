// =====================================================================
// MAP SECTION - Compact, Responsive, Consistent
// =====================================================================

// Use design system (must come before @import)
@use "../../../styles/components/sections/design-system" as *;
@use "../../../styles/components/sections/typography-system" as typo;
@use "../../../styles/osi-cards-mixins" as mixins;
@use "../../../styles/design-system/section-base" as section-base;
@use "../../../styles/responsive" as *;
@use "../../../styles/components/sections/section-animations" as *;

// Import base section styles
@import "../../../styles/components/sections/sections-base";
@import "../../../styles/components/sections/section-shell";

:host {
  display: block;
  width: 100%;
}

.map-container {
  display: flex;
  flex-direction: column;
  gap: var(--osi-section-item-gap) !important;
}

.map-wrapper {
  @include mixins.card-base;
  overflow: hidden;
  height: 280px; // Compact: 280px (was 300px)
  padding: 0; // Remove padding for map content
  position: relative; // Required for loading overlay positioning

  @include responsive-down("sm") {
    height: 180px; // Compact: 180px (was 200px)
  }
}

.map-element {
  width: 100%;
  height: 100%;
  background-color: var(--background); // Theme-aware background
}

.map-loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: color-mix(in srgb, var(--background) 85%, transparent);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--osi-section-item-gap); // 6px gap between section items
  z-index: 1000;
  pointer-events: none;
  transition: opacity 0.3s ease;

  .map-loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid color-mix(in srgb, var(--foreground) 20%, transparent);
    border-top-color: var(--status-info, #3b82f6);
    border-radius: 50%;
    animation: map-spin 1s linear infinite;
  }

  .map-loading-text {
    @include typo.label-base;
    color: var(--muted-foreground);
    font-size: var(--text-sm);
  }
}

@keyframes map-spin {
  to {
    transform: rotate(360deg);
  }
}

// Dark theme marker styling
:host ::ng-deep {
  .dark-map-marker {
    background: transparent !important;
    border: none !important;
    width: 20px !important;
    height: 20px !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;

    .marker-pin {
      width: 12px;
      height: 12px;
      background-color: var(--status-info, #3b82f6); // Blue marker using status color
      border: 2px solid var(--foreground);
      border-radius: 50%;
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 0.6),
        0 0 0 2px rgba(59, 130, 246, 0.3);
      display: block;
      visibility: visible;
      opacity: 1;
      position: relative;
      z-index: 1000;
    }
  }

  // Ensure Leaflet marker container is visible
  .leaflet-marker-icon {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  // Theme-aware popup styling
  .leaflet-popup-content-wrapper {
    background-color: var(--osi-section-item-background, var(--card-section-bg));
    color: var(--foreground);
    border-radius: var(--osi-radius-md);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .leaflet-popup-content {
    margin: 12px;
    color: var(--foreground);

    .dark-popup {
      color: var(--foreground);

      b {
        color: var(--foreground);
        font-weight: var(--font-semibold);
      }
    }
  }

  .leaflet-popup-tip {
    background-color: var(--osi-section-item-background, var(--card-section-bg));
  }

  .leaflet-popup-close-button {
    color: var(--foreground);
    opacity: 0.7;

    &:hover {
      opacity: 1;
    }
  }

  // Minimalistic map controls
  .leaflet-control-zoom {
    border: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    border-radius: var(--osi-radius-md);
    overflow: hidden;

    a {
      background-color: var(--osi-section-item-background, var(--card-section-bg));
      color: var(--foreground);
      border: none;
      width: 32px;
      height: 32px;
      line-height: 1;
      transition: background-color 0.2s;

      &:hover {
        background-color: var(--osi-section-item-background-hover, var(--card-section-card-bg));
      }
    }
  }

  .leaflet-control-attribution {
    background-color: color-mix(in srgb, var(--background) 80%, transparent);
    color: var(--muted-foreground);
    font-size: var(--text-xs);
    padding: 4px 8px;
    border-radius: var(--osi-radius-sm);

    a {
      color: var(--muted-foreground);
    }
  }

  // Ensure tiles are loaded and visible
  .leaflet-tile-container {
    opacity: 1 !important;
  }

  .leaflet-tile {
    opacity: 1 !important;
    visibility: visible !important;
  }

  // Loading indicator
  .leaflet-tile-loaded {
    opacity: 1 !important;
  }
}

.location-list {
  display: flex;
  flex-direction: column;
  gap: var(--osi-section-item-gap) !important;
  margin-top: var(--osi-section-item-padding-compact); // Compact: 6px
}

.section-item {
  @include card("normal");
  // Padding handled by card('normal') mixin - 12px uniform

  // Unified hover effect
  @include section-card-hover;

  @include responsive-down("sm") {
    // Padding handled by card('normal') mixin
  }
}

.location-name {
  @include heading(6);
  @include text-overflow-ellipsis(2); // Limit to 2 lines
  overflow-wrap: break-word;
  word-wrap: break-word;
}

.location-address {
  @include body-text("small");
  margin: var(--osi-section-item-gap-xs) 0 0; // Compact: 2px
  @include text-overflow-ellipsis(2); // Limit to 2 lines
  overflow-wrap: break-word;
  word-wrap: break-word;
}

.location-type {
  @include typo.label-base;
  text-transform: none;
  display: inline-block;
  margin-top: var(--osi-section-item-gap-xs); // Compact: 2px
}
