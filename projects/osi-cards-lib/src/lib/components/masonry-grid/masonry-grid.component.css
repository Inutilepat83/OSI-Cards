:host {
  display: block;
  width: 100%;
}

/* Screen reader only utility */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* ============================================================
   MASONRY CONTAINER
   ============================================================ */

.masonry-container {
  /* JavaScript positioning: Container uses relative positioning for absolute children */
  position: relative;
  width: 100%;
  min-height: 0;

  /* Smooth transitions */
  transition: opacity 0.25s ease;
  opacity: 1;
}

.masonry-container--loading {
  /* Keep full opacity to prevent blinking - use other visual cues instead */
  opacity: 1;
}

/* ═══════════════════════════════════════════════════════════════════════════
   STREAMING MODE - Magical Section Entrance Animations
   ═══════════════════════════════════════════════════════════════════════════ */

/* STREAMING STABILITY: Override loading opacity during streaming to prevent blinking
   When streaming, we want to keep existing content fully visible even during layout recalculations */
.masonry-container--streaming.masonry-container--loading {
  opacity: 1 !important;
}

.masonry-container--streaming {
  /* No container transitions during streaming */
  transition: none !important;
}

/* Base streaming mode - COMPLETE visual stability for existing sections */
.masonry-container--streaming .masonry-item {
  /* Force full opacity always */
  opacity: 1 !important;
  /* Disable ALL transitions during streaming to prevent flickering */
  transition: none !important;
  will-change: auto;
  /* Reset any filters that might cause visual changes */
  filter: none !important;
}

/* Non-animating items must remain completely stable - absolute stability */
.masonry-container--streaming .masonry-item:not(.masonry-item--animating) {
  animation: none !important;
  filter: none !important;
  /* Keep positioned but don't transform */
  transform: translateZ(0) !important;
  /* Ensure visibility */
  visibility: visible !important;
}

/* Gentle entrance animation ONLY for NEW sections (not already rendered) */
.masonry-item--animating {
  /* Simple fade-in with subtle slide - NO continuous glow animation */
  animation: masonry-gentle-enter 0.35s ease-out forwards;
  /* Subtle initial shadow - no harsh glow */
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  /* Enable pseudo-element positioning */
  position: relative;
  overflow: hidden;
}

/* Gentle fade-in with subtle slide - no blur, no bounce */
@keyframes masonry-gentle-enter {
  0% {
    opacity: 0;
    transform: translateY(8px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Shimmer sweep overlay - more subtle */
.masonry-item--animating::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(
    110deg,
    transparent 40%,
    rgba(255, 149, 0, 0.08) 50%,
    transparent 60%
  );
  animation: shimmer-sweep 0.5s ease-out forwards;
  pointer-events: none;
  border-radius: inherit;
  z-index: 10;
}

@keyframes shimmer-sweep {
  0% {
    transform: translateX(-100%);
    opacity: 0.8;
  }
  100% {
    transform: translateX(100%);
    opacity: 0;
  }
}

/* Subtle inner highlight - reduced intensity */
.masonry-item--animating::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  box-shadow: inset 0 0 15px rgba(255, 149, 0, 0.15);
  animation: inner-flash 0.4s ease-out forwards;
  pointer-events: none;
  z-index: 5;
}

@keyframes inner-flash {
  0% {
    opacity: 0.6;
  }
  100% {
    opacity: 0;
  }
}

/* ═══════════════════════════════════════════════════════════════════════════
   ANIMATED (COMPLETED) STATE - Sections that have finished their entrance
   This prevents the "first section keeps blinking" issue

   CRITICAL: Uses both class AND data-attribute selectors for maximum specificity
   ═══════════════════════════════════════════════════════════════════════════ */

/* Once animation completes, ensure section remains stable - CLASS selector */
.masonry-item--animated {
  /* Force full opacity - animation is done */
  opacity: 1 !important;
  /* No more animations on this section */
  animation: none !important;
  /* Remove any filters */
  filter: none !important;
  /* Ensure stable positioning */
  transform: translateZ(0) !important;
  /* Remove will-change to free up GPU memory */
  will-change: auto !important;
  /* Ensure visibility */
  visibility: visible !important;
}

/* DATA ATTRIBUTE FALLBACK - higher specificity */
.masonry-item[data-animated="true"] {
  opacity: 1 !important;
  animation: none !important;
  filter: none !important;
  transform: translateZ(0) !important;
  will-change: auto !important;
  visibility: visible !important;
}

/* Hide pseudo-elements on animated sections - CLASS selector */
.masonry-item--animated::before,
.masonry-item--animated::after {
  display: none !important;
  animation: none !important;
  opacity: 0 !important;
}

/* Hide pseudo-elements on animated sections - DATA ATTRIBUTE fallback */
.masonry-item[data-animated="true"]::before,
.masonry-item[data-animated="true"]::after {
  display: none !important;
  animation: none !important;
  opacity: 0 !important;
}

/* During streaming, animated sections should have NO visual effects - CLASS */
.masonry-container--streaming .masonry-item--animated {
  animation: none !important;
  transition: none !important;
  box-shadow: none !important;
  filter: none !important;
}

/* During streaming, animated sections - DATA ATTRIBUTE fallback */
.masonry-container--streaming .masonry-item[data-animated="true"] {
  animation: none !important;
  transition: none !important;
  box-shadow: none !important;
  filter: none !important;
}

/* Ensure all children of animated sections are also stable */
.masonry-item--animated *,
.masonry-item[data-animated="true"] * {
  animation: none !important;
}

.masonry-container--streaming .masonry-item--ready {
  /* Keep position transitions disabled during streaming */
  transition:
    top 0s,
    left 0s,
    width 0s !important;
}

/* ============================================================
   MASONRY ITEMS - FLIP ANIMATION SUPPORT
   ============================================================ */

.masonry-item {
  /* JavaScript positioning: Items use absolute positioning with left/top/width from JS */
  position: absolute;
  /* left, top, width are set via inline styles from positionedSections */
  height: auto;
  min-height: fit-content;

  /* Start at full opacity */
  opacity: 1;

  /* Pointer events enabled */
  pointer-events: auto;

  /* CSS containment for performance */
  contain: layout style paint;

  /* Ensure content determines height */
  display: flex;
  flex-direction: column;

  /* Smooth transitions for repositioning */
  transition:
    left 0.3s ease,
    top 0.3s ease,
    width 0.3s ease;
}

.masonry-item--ready {
  opacity: 1;

  /* FLIP-style transitions for smooth repositioning
   * Using cubic-bezier for natural easing
   * NO opacity transition - already at 1
   */
  transition:
    top 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
    left 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
    width 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
    transform 0.3s ease;
}

/* Staggered transition delays for position changes */
.masonry-item--ready:nth-child(1) {
  transition-delay: 0ms;
}
.masonry-item--ready:nth-child(2) {
  transition-delay: 30ms;
}
.masonry-item--ready:nth-child(3) {
  transition-delay: 60ms;
}
.masonry-item--ready:nth-child(4) {
  transition-delay: 90ms;
}
.masonry-item--ready:nth-child(5) {
  transition-delay: 120ms;
}
.masonry-item--ready:nth-child(6) {
  transition-delay: 150ms;
}
.masonry-item--ready:nth-child(7) {
  transition-delay: 180ms;
}
.masonry-item--ready:nth-child(8) {
  transition-delay: 210ms;
}
.masonry-item--ready:nth-child(n + 9) {
  transition-delay: 240ms;
}

/* Staggered animation delays for cascade effect on new sections - reduced for smoother feel */
.masonry-item--animating:nth-child(1) {
  animation-delay: 0ms;
}
.masonry-item--animating:nth-child(2) {
  animation-delay: 40ms;
}
.masonry-item--animating:nth-child(3) {
  animation-delay: 80ms;
}
.masonry-item--animating:nth-child(4) {
  animation-delay: 120ms;
}
.masonry-item--animating:nth-child(5) {
  animation-delay: 160ms;
}
.masonry-item--animating:nth-child(6) {
  animation-delay: 200ms;
}
.masonry-item--animating:nth-child(7) {
  animation-delay: 240ms;
}
.masonry-item--animating:nth-child(8) {
  animation-delay: 280ms;
}
.masonry-item--animating:nth-child(n + 9) {
  animation-delay: 320ms;
}

/* Ensure sections have proper containment */
.masonry-item > * {
  display: block;
  width: 100%;
  height: auto;
}

/* ============================================================
   RESPONSIVE OPTIMIZATIONS
   ============================================================ */

/* Mobile: faster transitions */
@media (max-width: 768px) {
  .masonry-container {
    min-height: 300px;
  }

  .masonry-item {
    /* Faster transitions on mobile */
    transition: opacity 0.3s ease;
  }

  .masonry-item--ready {
    transition:
      top 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      opacity 0.4s ease 0.05s;
  }

  /* Reduced stagger on mobile */
  .masonry-item--ready:nth-child(1) {
    transition-delay: 0ms;
  }
  .masonry-item--ready:nth-child(2) {
    transition-delay: 20ms;
  }
  .masonry-item--ready:nth-child(3) {
    transition-delay: 40ms;
  }
  .masonry-item--ready:nth-child(4) {
    transition-delay: 60ms;
  }
  .masonry-item--ready:nth-child(n + 5) {
    transition-delay: 80ms;
  }

  /* Reduced animation stagger on mobile */
  .masonry-item--animating:nth-child(1) {
    animation-delay: 0ms;
  }
  .masonry-item--animating:nth-child(2) {
    animation-delay: 50ms;
  }
  .masonry-item--animating:nth-child(3) {
    animation-delay: 100ms;
  }
  .masonry-item--animating:nth-child(4) {
    animation-delay: 150ms;
  }
  .masonry-item--animating:nth-child(n + 5) {
    animation-delay: 200ms;
  }
}

/* Wide screen: allow more height */
@media (min-width: 1400px) {
  .masonry-container {
    min-height: 500px;
  }
}

/* ============================================================
   VIRTUAL SCROLLING SUPPORT
   ============================================================ */

.masonry-container--virtual {
  /* Enable overflow for virtual scrolling */
  overflow-y: auto;
  overflow-x: hidden;

  /* Smooth scrolling behavior */
  scroll-behavior: smooth;

  /* Optimizations for scroll performance */
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

.masonry-virtual-spacer {
  /* Spacer maintains scroll height without affecting layout */
  pointer-events: none;
  visibility: hidden;
  position: absolute;
  top: 0;
  left: 0;
  width: 1px;
}

.masonry-item--virtual {
  /* Virtual items need stronger containment */
  contain: strict;

  /* Optimize for frequent show/hide */
  content-visibility: auto;
  contain-intrinsic-size: auto 200px;
}

/* Disable transitions for virtual scroll items to improve performance */
.masonry-container--virtual .masonry-item {
  transition: none !important;
  animation: none !important;
}

/* Re-enable position transitions only when not actively scrolling */
.masonry-container--virtual:not(:active) .masonry-item--ready {
  transition:
    top 0.3s ease,
    left 0.3s ease,
    width 0.3s ease;
}

/* ============================================================
   REDUCED MOTION SUPPORT
   ============================================================ */

@media (prefers-reduced-motion: reduce) {
  .masonry-container {
    transition: none;
  }

  .masonry-item,
  .masonry-item--ready,
  .masonry-item--animating {
    transition: none !important;
    animation: none !important;
    transition-delay: 0ms !important;
    animation-delay: 0ms !important;
    opacity: 1;
    filter: none;
  }

  .masonry-item--animating::before,
  .masonry-item--animating::after {
    display: none;
  }

  .masonry-container--virtual {
    scroll-behavior: auto;
  }
}
