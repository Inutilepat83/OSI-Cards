#!/usr/bin/env node

/**
 * Auto-Build Section Styles
 *
 * Automatically generates style bundle from discovered section SCSS files.
 * Creates _all-sections.scss that imports all section styles.
 *
 * Usage:
 *   node scripts/build-section-styles.js
 *   node scripts/build-section-styles.js --verify  (check only, don't write)
 */

const fs = require('fs');
const path = require('path');
const { discoverSections, ROOT_DIR } = require('./discover-sections');

// Colors
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
  red: '\x1b[31m',
  dim: '\x1b[2m',
};

function log(msg, color = colors.reset) {
  console.log(`${color}${msg}${colors.reset}`);
}

/**
 * Build style bundle from discovered sections
 */
function buildStyleBundle(sections) {
  const lines = [];

  // Header
  lines.push('/**');
  lines.push(' * Section Styles - Auto-Generated Bundle');
  lines.push(' * ');
  lines.push(' * This file is automatically generated from section folders.');
  lines.push(' * DO NOT EDIT MANUALLY - changes will be overwritten!');
  lines.push(' * ');
  lines.push(' * To add section styles: Create section SCSS file, run `npm run sections:build`');
  lines.push(' * To remove section styles: Delete SCSS file, run `npm run sections:build`');
  lines.push(' * ');
  lines.push(` * Generated: ${new Date().toISOString()}`);
  lines.push(` * Sections with styles: ${sections.filter(s => s.hasStyles).length}`);
  lines.push(' */');
  lines.push('');

  // Import base/shared styles first
  lines.push('// Base section styles (always included)');
  lines.push('@use \'./sections-base\' as *;');
  lines.push('');

  // Count sections with actual style files
  const sectionsWithStyles = sections.filter(s => s.hasStyles);

  if (sectionsWithStyles.length === 0) {
    lines.push('// No section-specific styles found');
    lines.push('// All sections use base styles only');
    return lines.join('\n') + '\n';
  }

  // Sort by type for consistent output
  const sorted = [...sectionsWithStyles].sort((a, b) => a.type.localeCompare(b.type));

  // Import each section's styles
  lines.push('// Section-specific styles (auto-discovered)');
  for (const section of sorted) {
    // Calculate relative path from styles directory to section SCSS
    const stylesDir = path.join(ROOT_DIR, 'projects', 'osi-cards-lib', 'src', 'lib', 'styles', 'components', 'sections');
    const relativePath = path.relative(stylesDir, section.styleFile);

    // Convert to SCSS @use syntax (Unix-style paths, no extension)
    const scssPath = relativePath.replace(/\\/g, '/').replace(/\.scss$/, '');

    lines.push(`@use '${scssPath}';  // ${section.type}`);
  }

  lines.push('');
  lines.push(`// Total section styles imported: ${sectionsWithStyles.length}`);

  return lines.join('\n') + '\n';
}

/**
 * Main execution
 */
function main() {
  const verifyOnly = process.argv.includes('--verify');

  log('\n' + 'â•'.repeat(70), colors.cyan);
  log('  Building Section Styles', colors.bright + colors.cyan);
  log('â•'.repeat(70), colors.cyan);

  // Discover sections
  log('\nðŸ” Discovering sections...', colors.blue);
  const sections = discoverSections();
  const sectionsWithStyles = sections.filter(s => s.hasStyles);
  log(`âœ… Found ${sections.length} sections (${sectionsWithStyles.length} with styles)`, colors.green);

  // Build style bundle
  log('\nðŸŽ¨ Generating style bundle...', colors.blue);
  const styleContent = buildStyleBundle(sections);

  log(`âœ… Style bundle generated`, colors.green);

  if (verifyOnly) {
    log('\nâœ“ Verification complete (no files written)', colors.dim);
    log('\nStyle bundle preview:', colors.dim);
    console.log(styleContent.substring(0, 500) + '...');
    return;
  }

  // Write style bundle
  const outputPath = path.join(
    ROOT_DIR,
    'projects',
    'osi-cards-lib',
    'src',
    'lib',
    'styles',
    'components',
    'sections',
    '_all-sections.generated.scss'
  );

  log('\nðŸ“ Writing _all-sections.generated.scss...', colors.blue);

  // Ensure directory exists
  const outputDir = path.dirname(outputPath);
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  fs.writeFileSync(outputPath, styleContent);

  const relativePath = path.relative(ROOT_DIR, outputPath);
  log(`âœ… Style bundle written to: ${relativePath}`, colors.green);

  // Print summary
  log('\n' + 'â•'.repeat(70), colors.cyan);
  log('  Summary', colors.bright + colors.cyan);
  log('â•'.repeat(70), colors.cyan);
  log(`\nðŸ“Š Sections with styles: ${sectionsWithStyles.length}`);
  log(`ðŸ“Š Sections without styles: ${sections.length - sectionsWithStyles.length}`);
  log(`ðŸ“„ Output file: ${relativePath}\n`);

  // List sections with styles
  if (sectionsWithStyles.length > 0) {
    log('Sections with custom styles:', colors.dim);
    sectionsWithStyles.forEach(s => {
      log(`  - ${s.type}`, colors.dim);
    });
  }

  log('\nâœ… Section styles build complete!', colors.green + colors.bright);
}

// Run if called directly
if (require.main === module) {
  try {
    main();
  } catch (error) {
    log(`\nâœ— Error: ${error.message}`, colors.red);
    console.error(error);
    process.exit(1);
  }
}

module.exports = { buildStyleBundle };

