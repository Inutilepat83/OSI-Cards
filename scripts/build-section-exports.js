#!/usr/bin/env node

/**
 * Auto-Build Section Exports
 *
 * Automatically generates sections/index.ts from discovered section modules.
 * This makes the exports file auto-maintained - no manual updates needed!
 *
 * Usage:
 *   node scripts/build-section-exports.js
 *   node scripts/build-section-exports.js --verify  (check only, don't write)
 */

const fs = require('fs');
const path = require('path');
const { discoverSections, ROOT_DIR, SECTIONS_DIR } = require('./discover-sections');

// Colors
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
  red: '\x1b[31m',
  dim: '\x1b[2m',
};

function log(msg, color = colors.reset) {
  console.log(`${color}${msg}${colors.reset}`);
}

/**
 * Build exports barrel file from discovered sections
 */
function buildExports(sections) {
  const lines = [];

  // Header
  lines.push('/**');
  lines.push(' * Section Components - Auto-Generated Exports');
  lines.push(' * ');
  lines.push(' * This file is automatically generated from section folders.');
  lines.push(' * DO NOT EDIT MANUALLY - changes will be overwritten!');
  lines.push(' * ');
  lines.push(' * To add a section: Create a new folder with 5 files, run `npm run sections:build`');
  lines.push(' * To remove a section: Delete the folder, run `npm run sections:build`');
  lines.push(' * ');
  lines.push(` * Generated: ${new Date().toISOString()}`);
  lines.push(` * Sections: ${sections.length}`);
  lines.push(' */');
  lines.push('');

  // Base section component (always export first)
  lines.push('// Base section component');
  lines.push('export * from \'./base-section.component\';');
  lines.push('export * from \'./abstract-section-bases\';');
  lines.push('');

  // Sort sections by type for consistent output
  const sortedSections = [...sections].sort((a, b) => a.type.localeCompare(b.type));

  // Export all section components
  lines.push('// Section Components (Auto-Generated)');
  for (const section of sortedSections) {
    const componentPath = `./${section.folderName}/${section.folderName}.component`;
    lines.push(`export { ${section.componentName} } from '${componentPath}';`);
  }

  return lines.join('\n') + '\n';
}

/**
 * Main execution
 */
function main() {
  const verifyOnly = process.argv.includes('--verify');

  log('\n' + 'â•'.repeat(70), colors.cyan);
  log('  Building Section Exports', colors.bright + colors.cyan);
  log('â•'.repeat(70), colors.cyan);

  // Discover sections
  log('\nðŸ” Discovering sections...', colors.blue);
  const sections = discoverSections();
  log(`âœ… Found ${sections.length} sections`, colors.green);

  // Build exports
  log('\nðŸ“¦ Generating exports...', colors.blue);
  const exportsContent = buildExports(sections);

  log(`âœ… Generated exports for ${sections.length} components`, colors.green);

  if (verifyOnly) {
    log('\nâœ“ Verification complete (no files written)', colors.dim);
    log('\nExports preview:', colors.dim);
    console.log(exportsContent.substring(0, 500) + '...');
    return;
  }

  // Write exports file
  const outputPath = path.join(SECTIONS_DIR, 'index.ts');
  log('\nðŸ“ Writing index.ts...', colors.blue);
  fs.writeFileSync(outputPath, exportsContent);

  const relativePath = path.relative(ROOT_DIR, outputPath);
  log(`âœ… Exports written to: ${relativePath}`, colors.green);

  // Print summary
  log('\n' + 'â•'.repeat(70), colors.cyan);
  log('  Summary', colors.bright + colors.cyan);
  log('â•'.repeat(70), colors.cyan);
  log(`\nðŸ“Š Components exported: ${sections.length}`);
  log(`ðŸ“„ Output file: ${relativePath}\n`);

  // List exported components
  log('Components exported:', colors.dim);
  sections.forEach(s => {
    log(`  - ${s.componentName.padEnd(35)} (${s.type})`, colors.dim);
  });

  log('\nâœ… Section exports build complete!', colors.green + colors.bright);
}

// Run if called directly
if (require.main === module) {
  try {
    main();
  } catch (error) {
    log(`\nâœ— Error: ${error.message}`, colors.red);
    console.error(error);
    process.exit(1);
  }
}

module.exports = { buildExports };

