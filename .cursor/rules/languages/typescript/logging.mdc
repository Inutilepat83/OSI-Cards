---
description: "Structured logging, Angular logging, logging best practices"
globs: ["**/*.ts", "**/*.tsx"]
---

# TypeScript Logging

## Structured Logging

### Log Levels

```typescript
enum LogLevel {
  DEBUG = 0,
  INFO = 1,
  WARN = 2,
  ERROR = 3
}

interface LogEntry {
  level: LogLevel;
  message: string;
  timestamp: string;
  context?: Record<string, unknown>;
  error?: Error;
}
```

### Logger Interface

```typescript
interface Logger {
  debug(message: string, context?: Record<string, unknown>): void;
  info(message: string, context?: Record<string, unknown>): void;
  warn(message: string, context?: Record<string, unknown>): void;
  error(message: string, error?: Error, context?: Record<string, unknown>): void;
}
```

## Implementation

### LoggerService (Library)

Library-level logging service with localStorage support:

```typescript
import { Injectable, inject } from '@angular/core';
import { LoggerService } from '@osi-cards/services';

// Configure logger
const logger = inject(LoggerService);
logger.configure({
  minLevel: 'info',
  enableConsole: true,
  enableStorage: true,  // Enable localStorage persistence
  maxStoredLogs: 1000
});

// Use logger
logger.info('User logged in', { userId: '123' });
logger.error('API call failed', { error, url }, error);

// Access logs from localStorage
const logs = LoggerService.getLogsFromLocalStorage();
logger.clearLocalStorageLogs();
const exported = logger.exportLocalStorageLogs();
```

### LoggingService (App)

Application-level logging service with localStorage support:

```typescript
import { inject } from '@angular/core';
import { LoggingService } from '@app/core/services/logging.service';

const logger = inject(LoggingService);

// Use logger
logger.info('User logged in', 'AuthService', { userId: '123' });
logger.error('API call failed', 'ApiService', { error, url });

// Access logs from localStorage
const logs = LoggingService.getLogsFromLocalStorage();
logger.clearLocalStorageLogs();
const exported = logger.exportLocalStorageLogs();
```

### LogEntry Structure

**LoggerService (Library):**
```typescript
interface LogEntry {
  timestamp: Date;
  level: 'debug' | 'info' | 'warn' | 'error';
  message: string;
  context?: Record<string, any>;
  stack?: string;
}
```

**LoggingService (App):**
```typescript
interface LogEntry {
  timestamp: Date;
  level: 'debug' | 'info' | 'warn' | 'error';
  message: string;
  context?: string;
  data?: unknown;
  correlationId?: string;
  userId?: string;
  sessionId?: string;
}
```

## Logging Libraries

### Winston (Node.js)

```typescript
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}
```

### Pino (Fast JSON Logger)

```typescript
import pino from 'pino';

const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: {
    target: 'pino-pretty',
    options: {
      colorize: true
    }
  }
});
```

## Logging Best Practices

### Contextual Information

```typescript
// ✅ Good - include context
logger.info('User created', {
  userId: user.id,
  email: user.email,
  timestamp: new Date().toISOString()
});

// ❌ Bad - no context
logger.info('User created');
```

### Error Logging

```typescript
// ✅ Good - include error and context
logger.error('Failed to create user', error, {
  userId: user.id,
  email: user.email,
  operation: 'createUser'
});

// ❌ Bad - just message
logger.error('Failed to create user');
```

### Sensitive Data

```typescript
// ❌ Bad - logging sensitive data
logger.info('User login', {
  email: user.email,
  password: user.password // Never log passwords!
});

// ✅ Good - exclude sensitive data
logger.info('User login', {
  userId: user.id,
  email: user.email // Email is okay, password is not
});
```

## Logging in Angular

### HTTP Interceptor

```typescript
@Injectable()
export class LoggingInterceptor implements HttpInterceptor {
  constructor(private logger: LoggerService) {}

  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    const startTime = Date.now();

    return next.handle(req).pipe(
      tap({
        next: (event) => {
          if (event instanceof HttpResponse) {
            const duration = Date.now() - startTime;
            this.logger.info('HTTP request completed', {
              method: req.method,
              url: req.url,
              status: event.status,
              duration: `${duration}ms`
            });
          }
        },
        error: (error) => {
          const duration = Date.now() - startTime;
          this.logger.error('HTTP request failed', error, {
            method: req.method,
            url: req.url,
            duration: `${duration}ms`
          });
        }
      })
    );
  }
}
```

## Correlation IDs

### Request Tracking

```typescript
@Injectable()
export class CorrelationIdService {
  private correlationId = this.generateId();

  getCorrelationId(): string {
    return this.correlationId;
  }

  setCorrelationId(id: string): void {
    this.correlationId = id;
  }

  private generateId(): string {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
}

// Usage in HTTP interceptor
intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
  const correlationId = this.correlationIdService.getCorrelationId();

  const clonedReq = req.clone({
    setHeaders: {
      'X-Correlation-ID': correlationId
    }
  });

  this.logger.info('HTTP request', {
    correlationId,
    method: req.method,
    url: req.url
  });

  return next.handle(clonedReq);
}
```

## Log Levels by Environment

### Development

- Log everything (DEBUG level)
- Pretty print logs
- Show stack traces

### Production

- Log INFO and above
- Structured JSON format
- Send to logging service
- Don't log sensitive data

## Best Practices

### ✅ Do

- Use structured logging
- Include contextual information
- Use appropriate log levels
- Log errors with stack traces
- Use correlation IDs
- Mask sensitive data
- Set log levels by environment

### ❌ Don't

- Log sensitive information (passwords, tokens)
- Log too much (performance impact)
- Use console.log in production
- Log in tight loops
- Ignore log levels
- Log without context

## localStorage Integration

### LoggerService (Library)

- **localStorage Key:** `osi-cards-logs`
- **Storage:** Opt-in (configure with `enableStorage: true`)
- **Methods:**
  - `LoggerService.getLogsFromLocalStorage()` - Static method to read logs
  - `logger.clearLocalStorageLogs()` - Clear localStorage logs
  - `logger.exportLocalStorageLogs()` - Export as JSON string

```typescript
// Configure with localStorage enabled
const logger = inject(LoggerService);
logger.configure({ enableStorage: true });

// Access logs
const logs = LoggerService.getLogsFromLocalStorage();
console.table(logs);

// Clear logs
logger.clearLocalStorageLogs();

// Export logs
const json = logger.exportLocalStorageLogs();
```

### LoggingService (App)

- **localStorage Key:** `osi-cards-app-logs`
- **Storage:** Always enabled
- **Methods:**
  - `LoggingService.getLogsFromLocalStorage()` - Static method to read logs
  - `logger.clearLocalStorageLogs()` - Clear localStorage logs
  - `logger.exportLocalStorageLogs()` - Export as JSON string

```typescript
const logger = inject(LoggingService);

// Access logs
const logs = LoggingService.getLogsFromLocalStorage();
console.table(logs);

// Clear logs
logger.clearLocalStorageLogs();

// Export logs
const json = logger.exportLocalStorageLogs();
```

## Cursor Debug Mode Integration

### Server-Based Logging

The debug-log server writes logs to `.cursor/debug.log`:

1. **Start debug server:**
   ```bash
   npm run debug:log:server
   ```

2. **Server endpoints:**
   - `POST /ingest/{session-id}` - Receives logs from browser
   - `GET /health` - Health check

3. **Cursor can read from:**
   - `.cursor/debug.log` - Debug server logs (NDJSON format)
   - localStorage keys: `osi-cards-logs`, `osi-cards-app-logs`

### Debug-Log Utilities

For specialized debug logging (performance monitoring, hypothesis tracking):

```typescript
import { sendDebugLog } from '@osi-cards/utils/debug-log.util';
import { sendDebugLogToFile } from '@osi-cards/utils/debug-log-file.util';

// Send to debug server (writes to .cursor/debug.log)
sendDebugLog({
  location: 'component.ts:methodName',
  message: 'Operation completed',
  data: { duration: 123 },
  timestamp: Date.now(),
  sessionId: 'session-123',
  runId: 'run-456',
  hypothesisId: 'H1'
});

// Store in localStorage (key: osi-cards-debug-logs)
sendDebugLogToFile({
  location: 'component.ts:methodName',
  message: 'Operation completed',
  data: { duration: 123 },
  timestamp: Date.now()
});
```

**See also:** `error-handling.mdc`, `code-quality.mdc`, `development/log-analysis.mdc`
