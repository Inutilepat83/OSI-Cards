---
description: "Frontend security: XSS prevention, CSP, input validation, dependency security"
alwaysApply: true
---

# Security Patterns

## Security-First Mindset

Security is not an afterthought. Consider security implications in every decision.

---

## XSS (Cross-Site Scripting) Prevention

### Angular's Built-in Protection

**Angular automatically escapes values in templates:**

```typescript
@Component({
  template: `
    <div>{{ userInput }}</div> <!-- Automatically escaped -->
  `
})
```

### Dangerous InnerHTML

**Avoid `innerHTML` and `[innerHTML]` with user input:**

```typescript
// ❌ Bad - Vulnerable to XSS
@Component({
  template: `
    <div [innerHTML]="userInput"></div>
  `
})

// ✅ Good - Use Angular's sanitization if needed
import { DomSanitizer } from '@angular/platform-browser';

@Component({
  template: `
    <div [innerHTML]="sanitizedHtml"></div>
  `
})
export class MyComponent {
  private readonly sanitizer = inject(DomSanitizer);
  
  get sanitizedHtml() {
    return this.sanitizer.sanitize(SecurityContext.HTML, this.userInput);
  }
}
```

### Guidelines

- Angular automatically escapes template values
- Avoid `[innerHTML]` with user input
- Use `DomSanitizer` if HTML is necessary
- Never trust user input
- Validate and sanitize all inputs

---

## Content Security Policy (CSP)

### CSP Headers

**Configure CSP headers in `index.html` or server:**

```html
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline';">
```

### CSP Configuration

```html
<!-- Strict CSP (recommended) -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self';
               style-src 'self' 'unsafe-inline';
               img-src 'self' data: https:;
               font-src 'self' data:;
               connect-src 'self' https:;">
```

### Guidelines

- Use strict CSP when possible
- Avoid `'unsafe-inline'` for scripts
- Use nonces for inline scripts/styles
- Test CSP in development
- Monitor CSP violations

---

## Input Validation

### Validate All Inputs

**Validate user input in components and services:**

```typescript
@Component({
  template: `
    <input [(ngModel)]="email" 
           type="email" 
           required
           pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
  `
})
export class MyComponent {
  email = '';
  
  validateEmail(email: string): boolean {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }
}
```

### Angular Forms Validation

```typescript
import { FormBuilder, Validators } from '@angular/forms';

export class MyComponent {
  private readonly fb = inject(FormBuilder);
  
  form = this.fb.group({
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required, Validators.minLength(8)]],
  });
}
```

### Guidelines

- Validate all user inputs
- Use Angular forms validation
- Validate on both client and server
- Provide clear validation messages
- Don't trust client-side validation alone

---

## URL Validation

### Validate URLs

**Validate URLs before using them:**

```typescript
function isValidUrl(url: string): boolean {
  try {
    const urlObj = new URL(url);
    // Only allow http/https
    return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
  } catch {
    return false;
  }
}

function sanitizeUrl(url: string): string | null {
  if (!isValidUrl(url)) {
    return null;
  }
  return url;
}
```

### Guidelines

- Validate URLs before use
- Only allow http/https protocols
- Use `URL` constructor for validation
- Don't use user-provided URLs in dangerous contexts
- Use allowlists for external resources

---

## Dependency Security

### Dependency Management

**Keep dependencies updated and secure:**

```bash
# Check for vulnerabilities
npm audit

# Fix vulnerabilities
npm audit fix

# Update dependencies
npm update
```

### Guidelines

- Regularly update dependencies
- Use `npm audit` to check for vulnerabilities
- Remove unused dependencies
- Use exact versions for critical dependencies
- Monitor security advisories

---

## HTTPS and Secure Communication

### HTTPS Everywhere

**Always use HTTPS for production:**

```typescript
// Environment configuration
export const environment = {
  production: true,
  apiUrl: 'https://api.example.com', // HTTPS
};
```

### Guidelines

- Use HTTPS for all API calls
- Use HTTPS for all external resources
- Enforce HTTPS in production
- Don't send sensitive data over HTTP
- Use secure cookies when applicable

---

## Secure Error Messages

### Don't Expose Internal Details

**Don't expose internal error details to users:**

```typescript
// ❌ Bad - Exposes internal details
catchError((error: HttpErrorResponse) => {
  throw new Error(error.error.message); // May expose sensitive info
})

// ✅ Good - Generic error message
catchError((error: HttpErrorResponse) => {
  console.error('Error:', error); // Log internally
  throw new Error('An error occurred. Please try again.'); // User-friendly
})
```

### Guidelines

- Don't expose stack traces to users
- Don't expose internal error messages
- Log detailed errors server-side
- Provide generic error messages to users
- Don't leak information about system internals

---

## Local Storage Security

### Sensitive Data Storage

**Don't store sensitive data in localStorage:**

```typescript
// ❌ Bad - Stores sensitive data
localStorage.setItem('password', password);
localStorage.setItem('token', authToken);

// ✅ Good - Don't store sensitive data
// Use secure HTTP-only cookies for tokens
// Use sessionStorage for temporary data (session only)
sessionStorage.setItem('tempData', data);
```

### Guidelines

- Don't store passwords in localStorage
- Don't store tokens in localStorage (use HTTP-only cookies)
- Use sessionStorage for temporary data
- Encrypt sensitive data if storage is necessary
- Clear localStorage on logout

---

## Third-Party Scripts

### Trusted Sources Only

**Only load scripts from trusted sources:**

```html
<!-- ✅ Good - From trusted CDN -->
<script src="https://cdn.example.com/library.js"></script>

<!-- ❌ Bad - From untrusted source -->
<script src="http://untrusted-source.com/script.js"></script>
```

### Guidelines

- Only load scripts from trusted sources
- Use Subresource Integrity (SRI) for CDN scripts
- Minimize third-party scripts
- Review third-party script security
- Use Content Security Policy to restrict sources

---

## Security Checklist

Before deploying:

- [ ] XSS prevention implemented
- [ ] CSP headers configured
- [ ] Input validation implemented
- [ ] URL validation implemented
- [ ] Dependencies updated and audited
- [ ] HTTPS used for all communications
- [ ] Error messages don't expose internal details
- [ ] No sensitive data in localStorage
- [ ] Third-party scripts from trusted sources
- [ ] Security testing completed

---

## Angular-Specific Security

### Angular Security Features

- **Automatic XSS Protection**: Template values are automatically escaped
- **Safe Navigation**: `?.` operator prevents null reference errors
- **Type Safety**: TypeScript helps prevent security vulnerabilities
- **Dependency Injection**: Secure service injection patterns

### Guidelines

- Trust Angular's built-in XSS protection
- Use Angular forms for input validation
- Use TypeScript for type safety
- Use dependency injection for services
- Follow Angular security best practices

**See also:** `error-handling.mdc`, `angular-components.mdc`, `testing.mdc`
